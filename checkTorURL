#o!/bin/bash
#set -x
#set -x #uncomment to unable debug mode
function testArg {

    local readonly usage="usage : checkTorURL [input FILE] [output FILE] \n Example: checkTorURL inputOnionFile.txt result.txt "
    
    if [[ $# != 2 ]]
    then
        echo "ERROR : with the number of arguments"
        echo "$usage"
        exit -1
    fi
    
    if [[ ! -f $1 ]]
    then
        echo "ERROR : input File $1 doesn't exist."
        echo "$usage"
         exit -1
    fi
}

function extractAndSortUnionLink {

    local  readonly inputFile="$1"
    local unsortOnionLink=$(tempfile)
    local onionLink=$(tempfile)
    
    grep -oE "[http:\/\/]*?[[:alnum:]]*.onion" $inputFile > $unsortOnionLink
    
    sort -u $unsortOnionLink >$onionLink
    
    while read line
    do
        testURL "$line" "$2" &
        wait
    done < $onionLink
    rm $unsortOnionLink $onionLink
}

# remove error or default pages
function removeErrorPages {
    local readonly outputFile="$2"
    siteAvailable=1
    tabError=("There is no site here!" "404" "403" "302" "Welcome to nginx" "It works" "Alert")
    local readonly URL="$1"
    local message=$(usewithtor curl -m10 $URL 2> /dev/null)
    
    for error in "${tabError[@]}"
    do
	if [ ! -z "$(echo "$message" | grep -Eo "$error" )" ]; then
            siteAvailable=0
        fi
    done
    
    if [ $siteAvailable -eq 1 ]; then
        title=$(echo "$message"|sed -n 's/.*<title>\(.*\)<\/title>.*/\1/ip;T;q')
        echo "$URL - $title" >> "$2"
        echo "$URL -$title valide"
    fi
}

function testURL {
#extract .onion line
    local readonly line="$1"
    
    URL=$(echo "$line" |grep -oE "[http:\/\/]*?[[:alnum:]]*.onion")

#if .onion find
    if [ ! -z "$URL" ]
    then

#ping .onion link
        local message=$(usewithtor httping -t30 -c1 $URL 2> /dev/null )
        wait

#extract ping connection message
        local pingOK=$(echo "$message" |grep -oE "1 connects, 1 ok")

        if [ ! -z "$pingOK" ]; then
            removeErrorPages "$URL" "$2"
        fi
    fi
}

testArg "$@"
extractAndSortUnionLink "$@"
